<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Concurrent::Atom
  
    &mdash; Concurrent
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../';
  framesUrl = "../frames.html#!Concurrent/Atom.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (A)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../root/Concurrent.html" title="Concurrent (module)">Concurrent</a></span></span>
     &raquo; 
    <span class="title">Atom</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Concurrent::Atom
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="Synchronization/Object.html" title="Concurrent::Synchronization::Object (class)">Synchronization::Object</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next"><span class='object_link'><a href="Synchronization/Object.html" title="Concurrent::Synchronization::Object (class)">Synchronization::Object</a></span></li>
          
            <li class="next">Concurrent::Atom</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2"><span class='object_link'><a href="Concern/Dereferenceable.html" title="Concurrent::Concern::Dereferenceable (module)">Concern::Dereferenceable</a></span></dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/concurrent/atom.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Atoms provide a way to manage shared, synchronous, independent state.</p>

<p>An atom is initialized with an initial value and an optional validation
proc. At any time the value of the atom can be synchronously and safely
changed. If a validator is given at construction then any new value
will be checked against the validator and will be rejected if the
validator returns false or raises an exception.</p>

<p>There are two ways to change the value of an atom: <span class='object_link'><a href="#compare_and_set-instance_method" title="Concurrent::Atom#compare_and_set (method)">#compare_and_set</a></span> and
<span class='object_link'><a href="#swap-instance_method" title="Concurrent::Atom#swap (method)">#swap</a></span>. The former will set the new value if and only if it validates and
the current value matches the new value. The latter will atomically set the
new value to the result of running the given block if and only if that
value validates.</p>

<h2>Copy Options</h2>

<p>Object references in Ruby are mutable. This can lead to serious
problems when the <span class='object_link'><a href="#value-instance_method" title="Concurrent::Atom#value (method)">#value</a></span> of an object is a mutable reference. Which
is always the case unless the value is a <code>Fixnum</code>, <code>Symbol</code>, or similar
&quot;primative&quot; data type. Each instance can be configured with a few
options that can help protect the program from potentially dangerous
operations. Each of these options can be optionally set when the oject
instance is created:</p>

<ul>
<li><code>:dup_on_deref</code> When true the object will call the <code>#dup</code> method on
the <code>value</code> object every time the <code>#value</code> methid is called
(default: false)</li>
<li><code>:freeze_on_deref</code> When true the object will call the <code>#freeze</code>
method on the <code>value</code> object every time the <code>#value</code> method is called
(default: false)</li>
<li><code>:copy_on_deref</code> When given a <code>Proc</code> object the <code>Proc</code> will be run
every time   the <code>#value</code> method is called. The <code>Proc</code> will be given
the current <code>value</code> as its only argument and the result returned by
the block will be the return   value of the <code>#value</code> call. When <code>nil</code>
this option will be ignored (default: nil)</li>
</ul>

<p>When multiple deref options are set the order of operations is strictly defined.
The order of deref operations is:</p>

<ul>
<li><code>:copy_on_deref</code></li>
<li><code>:dup_on_deref</code></li>
<li><code>:freeze_on_deref</code></li>
</ul>

<p>Because of this ordering there is no need to <code>#freeze</code> an object created by a
provided <code>:copy_on_deref</code> block. Simply set <code>:freeze_on_deref</code> to <code>true</code>.
Setting both <code>:dup_on_deref</code> to <code>true</code> and <code>:freeze_on_deref</code> to <code>true</code> is
as close to the behavior of a &quot;pure&quot; functional language (like Erlang, Clojure,
or Haskell) as we are likely to get in Ruby.</p>


  </div>
</div>
<div class="tags">
  

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="http://clojure.org/atoms" target="_parent" title="Clojure Atoms">Clojure Atoms</a></li>
    
  </ul>

</div>






  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#compare_and_set-instance_method" title="#compare_and_set (instance method)">- (Boolean) <strong>compare_and_set</strong>(old_value, new_value) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Atomically sets the value of atom to the new value if and only if the current value of the atom is identical to the old value and the new value successfully validates against the (optional) validator given at construction.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (Atom) <strong>initialize</strong>(value, opts = {}) </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Create a new atom with the given initial value.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#swap-instance_method" title="#swap (instance method)">- (Object) <strong>swap</strong>(*args) {|value, args| ... }</a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Atomically swaps the value of atom using the given block.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#value-instance_method" title="#value (instance method)">- (Object) <strong>value</strong> </a>
    

    
      (also: #deref)
    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>The current value of the atom.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  <div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Concurrent::Atom (class)">Atom</a></span></tt>) <strong>initialize</strong>(value, opts = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Create a new atom with the given initial value.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>value</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The initial value</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>opts</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The options used to configure the atom</p>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    <p class="tag_title">Options Hash (<tt>opts</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:validator</span>
          <span class="type">(<tt>Proc</tt>)</span>
          <span class="default">
            
              &mdash; default:
              <tt>nil</tt>
            
          </span>
          
            &mdash; <div class='inline'><p>Optional proc used to validate new
values. It must accept one and only one argument which will be the
intended new value. The validator will return true if the new value
is acceptable else return false (preferrably) or raise an exception.</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:dup_on_deref</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
              &mdash; default:
              <tt>false</tt>
            
          </span>
          
            &mdash; <div class='inline'><p>Call <code>#dup</code> before
returning the data from <span class='object_link'><a href="#value-instance_method" title="Concurrent::Atom#value (method)">#value</a></span></p>
</div>
          
        </li>
      
        <li>
          <span class="name">:freeze_on_deref</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
              &mdash; default:
              <tt>false</tt>
            
          </span>
          
            &mdash; <div class='inline'><p>Call <code>#freeze</code> before
returning the data from <span class='object_link'><a href="#value-instance_method" title="Concurrent::Atom#value (method)">#value</a></span></p>
</div>
          
        </li>
      
        <li>
          <span class="name">:copy_on_deref</span>
          <span class="type">(<tt>Proc</tt>)</span>
          <span class="default">
            
              &mdash; default:
              <tt>nil</tt>
            
          </span>
          
            &mdash; <div class='inline'><p>When calling the <span class='object_link'><a href="#value-instance_method" title="Concurrent::Atom#value (method)">#value</a></span>
method, call the given proc passing the internal value as the sole
argument then return the new value returned from the proc.</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>ArgumentError</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>if the validator is not a <code>Proc</code> (when given)</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


39
40
41
42
43
44
45
46
47
48</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atom.rb', line 39</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>super</span><span class='lparen'>(</span><span class='rparen'>)</span>

  <span class='ivar'>@validator</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='symbol'>:validator</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span><span class='lparen'>(</span><span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='tlambeg'>{</span> <span class='kw'>true</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>validator must be a proc</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@validator</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Proc</span>

  <span class='ivar'>@value</span> <span class='op'>=</span> <span class='const'>Concurrent</span><span class='op'>::</span><span class='const'>AtomicReference</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ns_set_deref_options'>ns_set_deref_options</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ensure_ivar_visibility!'>ensure_ivar_visibility!</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="compare_and_set-instance_method">
  
    - (<tt>Boolean</tt>) <strong>compare_and_set</strong>(old_value, new_value) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Atomically sets the value of atom to the new value if and only if the
current value of the atom is identical to the old value and the new
value successfully validates against the (optional) validator given
at construction.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>old_value</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The expected current value.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>new_value</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The intended new value.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>True if the value is changed else false.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


112
113
114
115
116</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atom.rb', line 112</span>

<span class='kw'>def</span> <span class='id identifier rubyid_compare_and_set'>compare_and_set</span><span class='lparen'>(</span><span class='id identifier rubyid_old_value'>old_value</span><span class='comma'>,</span> <span class='id identifier rubyid_new_value'>new_value</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_compare_and_set!'>compare_and_set!</span><span class='lparen'>(</span><span class='id identifier rubyid_old_value'>old_value</span><span class='comma'>,</span> <span class='id identifier rubyid_new_value'>new_value</span><span class='rparen'>)</span>
<span class='kw'>rescue</span>
  <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="swap-instance_method">
  
    - (<tt>Object</tt>) <strong>swap</strong>(*args) {|value, args| ... }
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'><p>The given block may be called multiple times, and thus should be free
of side effects.</p>
</div>
  </div>

<p>Atomically swaps the value of atom using the given block. The current
value will be passed to the block, as will any arguments passed as
arguments to the function. The new value will be validated against the
(optional) validator proc given at construction. If validation fails the
value will not be changed.</p>

<p>Internally, <span class='object_link'><a href="#swap-instance_method" title="Concurrent::Atom#swap (method)">#swap</a></span> reads the current value, applies the block to it, and
attempts to compare-and-set it in. Since another thread may have changed
the value in the intervening time, it may have to retry, and does so in a
spin loop. The net effect is that the value will always be the result of
the application of the supplied block to a current value, atomically.
However, because the block might be called multiple times, it must be free
of side effects.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>args</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Zero or more arguments passed to the block.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'>(<tt>value</tt>, <tt>args</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Calculates a new value for the atom based on the
current value and any supplied agruments.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Yield Parameters:</p>
<ul class="yieldparam">
  
    <li>
      
        <span class='name'>value</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The current value of the atom.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>args</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>All arguments passed to the function, in order.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Yield Returns:</p>
<ul class="yieldreturn">
  
    <li>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The intended new value of the atom.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The final value of the atom after all operations and
validations are complete.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>ArgumentError</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>When no block is given.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


87
88
89
90
91
92
93
94
95
96
97
98
99
100</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atom.rb', line 87</span>

<span class='kw'>def</span> <span class='id identifier rubyid_swap'>swap</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>no block given</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_block_given?'>block_given?</span>

  <span class='kw'>begin</span>
    <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_old_value'>old_value</span> <span class='op'>=</span> <span class='ivar'>@value</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
      <span class='id identifier rubyid_new_value'>new_value</span> <span class='op'>=</span> <span class='kw'>yield</span><span class='lparen'>(</span><span class='id identifier rubyid_old_value'>old_value</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_old_value'>old_value</span> <span class='kw'>unless</span> <span class='ivar'>@validator</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_new_value'>new_value</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_new_value'>new_value</span> <span class='kw'>if</span> <span class='id identifier rubyid_compare_and_set!'>compare_and_set!</span><span class='lparen'>(</span><span class='id identifier rubyid_old_value'>old_value</span><span class='comma'>,</span> <span class='id identifier rubyid_new_value'>new_value</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span>
    <span class='kw'>return</span> <span class='ivar'>@value</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="value-instance_method">
  
    - (<tt>Object</tt>) <strong>value</strong> 
  

  
    <span class="aliases">Also known as:
    <span class="names"><span id='deref-instance_method'>deref</span></span>
    </span>
  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>The current value of the atom.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The current value.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


53
54
55</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atom.rb', line 53</span>

<span class='kw'>def</span> <span class='id identifier rubyid_value'>value</span>
  <span class='id identifier rubyid_apply_deref_options'>apply_deref_options</span><span class='lparen'>(</span><span class='ivar'>@value</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Fri Jul 10 12:10:58 2015 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.2.1).
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57940973-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>