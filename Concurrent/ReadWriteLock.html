<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Concurrent::ReadWriteLock
  
    &mdash; Concurrent
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../';
  framesUrl = "../frames.html#!Concurrent/ReadWriteLock.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (R)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Concurrent.html" title="Concurrent (module)">Concurrent</a></span></span>
     &raquo; 
    <span class="title">ReadWriteLock</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Concurrent::ReadWriteLock
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Concurrent::ReadWriteLock</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/concurrent/atomic/read_write_lock.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'><p>Do <strong>not</strong> try to acquire the write lock while already holding a read lock
<strong>or</strong> try to acquire the write lock while you already have it.
This will lead to deadlock</p>
</div>
  </div>

<p>Ruby read-write lock implementation</p>

<p>Allows any number of concurrent readers, but only one concurrent writer
(And if the &quot;write&quot; lock is taken, any readers who come along will have to wait)</p>

<p>If readers are already active when a writer comes along, the writer will wait for
all the readers to finish before going ahead.
Any additional readers that come when the writer is already waiting, will also
wait (so writers are not starved).</p>

<p>This implementation is based on <code>java.util.concurrent.ReentrantReadWriteLock</code>.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Concurrent</span><span class='op'>::</span><span class='const'>ReadWriteLock</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
<span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_with_read_lock'>with_read_lock</span>  <span class='lbrace'>{</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_retrieve'>retrieve</span> <span class='rbrace'>}</span>
<span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_with_write_lock'>with_write_lock</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_modify!'>modify!</span> <span class='rbrace'>}</span></code></pre>
    
  </div>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/locks/ReentrantReadWriteLock.html" target="_parent" title="java.util.concurrent.ReentrantReadWriteLock">java.util.concurrent.ReentrantReadWriteLock</a></li>
    
  </ul>

</div>
  <h2>Constant Summary</h2>
  







  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#acquire_read_lock-instance_method" title="#acquire_read_lock (instance method)">- (Boolean) <strong>acquire_read_lock</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Acquire a read lock.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#acquire_write_lock-instance_method" title="#acquire_write_lock (instance method)">- (Boolean) <strong>acquire_write_lock</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Acquire a write lock.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#has_waiters%3F-instance_method" title="#has_waiters? (instance method)">- (Boolean) <strong>has_waiters?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Queries whether any threads are waiting to acquire the read or write lock.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (ReadWriteLock) <strong>initialize</strong> </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Create a new <code>ReadWriteLock</code> in the unlocked state.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#release_read_lock-instance_method" title="#release_read_lock (instance method)">- (Boolean) <strong>release_read_lock</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Release a previously acquired read lock.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#release_write_lock-instance_method" title="#release_write_lock (instance method)">- (Boolean) <strong>release_write_lock</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Release a previously acquired write lock.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#to_s-instance_method" title="#to_s (instance method)">- (Object) <strong>to_s</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns a string representing <em>obj</em>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#with_read_lock-instance_method" title="#with_read_lock (instance method)">- (Object) <strong>with_read_lock</strong> { ... }</a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Execute a block operation within a read lock.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#with_write_lock-instance_method" title="#with_write_lock (instance method)">- (Object) <strong>with_write_lock</strong> { ... }</a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Execute a block operation within a write lock.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#write_locked%3F-instance_method" title="#write_locked? (instance method)">- (Boolean) <strong>write_locked?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Queries if the write lock is held by any thread.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Concurrent::ReadWriteLock (class)">ReadWriteLock</a></span></tt>) <strong>initialize</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Create a new <code>ReadWriteLock</code> in the unlocked state.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


55
56
57
58
59
60
61</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atomic/read_write_lock.rb', line 55</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>
  <span class='ivar'>@counter</span>      <span class='op'>=</span> <span class='const'>Atomic</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='int'>0</span><span class='rparen'>)</span>         <span class='comment'># single integer which represents lock state
</span>  <span class='ivar'>@reader_q</span>     <span class='op'>=</span> <span class='const'>ConditionVariable</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='comment'># queue for waiting readers
</span>  <span class='ivar'>@reader_mutex</span> <span class='op'>=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>             <span class='comment'># to protect reader queue
</span>  <span class='ivar'>@writer_q</span>     <span class='op'>=</span> <span class='const'>ConditionVariable</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='comment'># queue for waiting writers
</span>  <span class='ivar'>@writer_mutex</span> <span class='op'>=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>             <span class='comment'># to protect writer queue
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="acquire_read_lock-instance_method">
  
    - (<tt>Boolean</tt>) <strong>acquire_read_lock</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Acquire a read lock. If a write lock has been acquired will block until
it is released. Will not block if other read locks have been acquired.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>true if the lock is successfully acquired</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Concurrent.html#ResourceLimitError-constant" title="Concurrent::ResourceLimitError (constant)">Concurrent::ResourceLimitError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>if the maximum number of readers
is exceeded.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atomic/read_write_lock.rb', line 108</span>

<span class='kw'>def</span> <span class='id identifier rubyid_acquire_read_lock'>acquire_read_lock</span>
  <span class='kw'>while</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ResourceLimitError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Too many reader threads</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_max_readers?'>max_readers?</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>

    <span class='comment'># If a writer is waiting when we first queue up, we need to wait
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_waiting_writer?'>waiting_writer?</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
      <span class='comment'># But it is possible that the writer could finish and decrement @counter right here...
</span>      <span class='ivar'>@reader_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span> 
        <span class='comment'># So check again inside the synchronized section
</span>        <span class='ivar'>@reader_q</span><span class='period'>.</span><span class='id identifier rubyid_wait'>wait</span><span class='lparen'>(</span><span class='ivar'>@reader_mutex</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_waiting_writer?'>waiting_writer?</span>
      <span class='kw'>end</span>

      <span class='comment'># after a reader has waited once, they are allowed to &quot;barge&quot; ahead of waiting writers
</span>      <span class='comment'># but if a writer is *running*, the reader still needs to wait (naturally)
</span>      <span class='kw'>while</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_running_writer?'>running_writer?</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
          <span class='ivar'>@reader_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
            <span class='ivar'>@reader_q</span><span class='period'>.</span><span class='id identifier rubyid_wait'>wait</span><span class='lparen'>(</span><span class='ivar'>@reader_mutex</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_running_writer?'>running_writer?</span>
          <span class='kw'>end</span>
        <span class='kw'>else</span>
          <span class='kw'>return</span> <span class='kw'>if</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_compare_and_swap'>compare_and_swap</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='comma'>,</span><span class='id identifier rubyid_c'>c</span><span class='op'>+</span><span class='int'>1</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='kw'>break</span> <span class='kw'>if</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_compare_and_swap'>compare_and_swap</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='comma'>,</span><span class='id identifier rubyid_c'>c</span><span class='op'>+</span><span class='int'>1</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>    
  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="acquire_write_lock-instance_method">
  
    - (<tt>Boolean</tt>) <strong>acquire_write_lock</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Acquire a write lock. Will block and wait for all active readers and writers.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>true if the lock is successfully acquired</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Concurrent.html#ResourceLimitError-constant" title="Concurrent::ResourceLimitError (constant)">Concurrent::ResourceLimitError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>if the maximum number of writers
is exceeded.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atomic/read_write_lock.rb', line 163</span>

<span class='kw'>def</span> <span class='id identifier rubyid_acquire_write_lock'>acquire_write_lock</span>
  <span class='kw'>while</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ResourceLimitError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Too many writer threads</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_max_writers?'>max_writers?</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_c'>c</span> <span class='op'>==</span> <span class='int'>0</span> <span class='comment'># no readers OR writers running
</span>      <span class='comment'># if we successfully swap the RUNNING_WRITER bit on, then we can go ahead
</span>      <span class='kw'>break</span> <span class='kw'>if</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_compare_and_swap'>compare_and_swap</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='const'>RUNNING_WRITER</span><span class='rparen'>)</span>
    <span class='kw'>elsif</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_compare_and_swap'>compare_and_swap</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='comma'>,</span><span class='id identifier rubyid_c'>c</span><span class='op'>+</span><span class='const'>WAITING_WRITER</span><span class='rparen'>)</span>
      <span class='kw'>while</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span>
        <span class='comment'># Now we have successfully incremented, so no more readers will be able to increment
</span>        <span class='comment'>#   (they will wait instead)
</span>        <span class='comment'># However, readers OR writers could decrement right here, OR another writer could increment
</span>        <span class='ivar'>@writer_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
          <span class='comment'># So we have to do another check inside the synchronized section
</span>          <span class='comment'># If a writer OR reader is running, then go to sleep
</span>          <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
          <span class='ivar'>@writer_q</span><span class='period'>.</span><span class='id identifier rubyid_wait'>wait</span><span class='lparen'>(</span><span class='ivar'>@writer_mutex</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_running_writer?'>running_writer?</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid_running_readers?'>running_readers?</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
        <span class='kw'>end</span>

        <span class='comment'># We just came out of a wait
</span>        <span class='comment'># If we successfully turn the RUNNING_WRITER bit on with an atomic swap,
</span>        <span class='comment'># Then we are OK to stop waiting and go ahead
</span>        <span class='comment'># Otherwise go back and wait again
</span>        <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
        <span class='kw'>break</span> <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_running_writer?'>running_writer?</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_running_readers?'>running_readers?</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
          <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_compare_and_swap'>compare_and_swap</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='comma'>,</span><span class='id identifier rubyid_c'>c</span><span class='op'>+</span><span class='const'>RUNNING_WRITER</span><span class='op'>-</span><span class='const'>WAITING_WRITER</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='kw'>break</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="has_waiters?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>has_waiters?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Queries whether any threads are waiting to acquire the read or write lock.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>true if any threads are waiting for a lock else false</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


239
240
241</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atomic/read_write_lock.rb', line 239</span>

<span class='kw'>def</span> <span class='id identifier rubyid_has_waiters?'>has_waiters?</span>
  <span class='id identifier rubyid_waiting_writer?'>waiting_writer?</span><span class='lparen'>(</span><span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="release_read_lock-instance_method">
  
    - (<tt>Boolean</tt>) <strong>release_read_lock</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Release a previously acquired read lock.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>true if the lock is successfully released</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


143
144
145
146
147
148
149
150
151
152
153
154
155</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atomic/read_write_lock.rb', line 143</span>

<span class='kw'>def</span> <span class='id identifier rubyid_release_read_lock'>release_read_lock</span>
  <span class='kw'>while</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
    <span class='kw'>if</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_compare_and_swap'>compare_and_swap</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='comma'>,</span><span class='id identifier rubyid_c'>c</span><span class='op'>-</span><span class='int'>1</span><span class='rparen'>)</span>
      <span class='comment'># If one or more writers were waiting, and we were the last reader, wake a writer up
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_waiting_writer?'>waiting_writer?</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_running_readers'>running_readers</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span> <span class='op'>==</span> <span class='int'>1</span>
        <span class='ivar'>@writer_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='lbrace'>{</span> <span class='ivar'>@writer_q</span><span class='period'>.</span><span class='id identifier rubyid_signal'>signal</span> <span class='rbrace'>}</span>
      <span class='kw'>end</span>
      <span class='kw'>break</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="release_write_lock-instance_method">
  
    - (<tt>Boolean</tt>) <strong>release_write_lock</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Release a previously acquired write lock.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>true if the lock is successfully released</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


200
201
202
203
204
205
206
207
208
209
210
211
212</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atomic/read_write_lock.rb', line 200</span>

<span class='kw'>def</span> <span class='id identifier rubyid_release_write_lock'>release_write_lock</span>
  <span class='kw'>while</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
    <span class='kw'>if</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_compare_and_swap'>compare_and_swap</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='comma'>,</span><span class='id identifier rubyid_c'>c</span><span class='op'>-</span><span class='const'>RUNNING_WRITER</span><span class='rparen'>)</span>
      <span class='ivar'>@reader_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='lbrace'>{</span> <span class='ivar'>@reader_q</span><span class='period'>.</span><span class='id identifier rubyid_broadcast'>broadcast</span> <span class='rbrace'>}</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_waiting_writers'>waiting_writers</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='comment'># if any writers are waiting...
</span>        <span class='ivar'>@writer_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='lbrace'>{</span> <span class='ivar'>@writer_q</span><span class='period'>.</span><span class='id identifier rubyid_signal'>signal</span> <span class='rbrace'>}</span>
      <span class='kw'>end</span>
      <span class='kw'>break</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="to_s-instance_method">
  
    - (<tt>Object</tt>) <strong>to_s</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns a string representing <em>obj</em>. Includes the current reader and
writer counts.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


216
217
218
219
220
221
222
223
224
225
226
227</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atomic/read_write_lock.rb', line 216</span>

<span class='kw'>def</span> <span class='id identifier rubyid_to_s'>to_s</span>
  <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
  <span class='id identifier rubyid_s'>s</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_running_writer?'>running_writer?</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1 writer running, </span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_running_readers'>running_readers</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_running_readers'>running_readers</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> readers running, </span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>

  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;ReadWriteLock:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_object_id'>object_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='lparen'>(</span><span class='int'>16</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_s'>s</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_waiting_writers'>waiting_writers</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> writers waiting&gt;</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="with_read_lock-instance_method">
  
    - (<tt>Object</tt>) <strong>with_read_lock</strong> { ... }
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Execute a block operation within a read lock.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'><p>the task to be performed within the lock.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the result of the block operation.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>ArgumentError</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>when no block is given.</p>
</div>
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Concurrent.html#ResourceLimitError-constant" title="Concurrent::ResourceLimitError (constant)">Concurrent::ResourceLimitError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>if the maximum number of readers
is exceeded.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


72
73
74
75
76
77
78
79
80</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atomic/read_write_lock.rb', line 72</span>

<span class='kw'>def</span> <span class='id identifier rubyid_with_read_lock'>with_read_lock</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>no block given</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_block_given?'>block_given?</span>
  <span class='id identifier rubyid_acquire_read_lock'>acquire_read_lock</span>
  <span class='kw'>begin</span>
    <span class='kw'>yield</span>
  <span class='kw'>ensure</span>
    <span class='id identifier rubyid_release_read_lock'>release_read_lock</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="with_write_lock-instance_method">
  
    - (<tt>Object</tt>) <strong>with_write_lock</strong> { ... }
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Execute a block operation within a write lock.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'><p>the task to be performed within the lock.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the result of the block operation.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>ArgumentError</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>when no block is given.</p>
</div>
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Concurrent.html#ResourceLimitError-constant" title="Concurrent::ResourceLimitError (constant)">Concurrent::ResourceLimitError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>if the maximum number of readers
is exceeded.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


91
92
93
94
95
96
97
98
99</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atomic/read_write_lock.rb', line 91</span>

<span class='kw'>def</span> <span class='id identifier rubyid_with_write_lock'>with_write_lock</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>no block given</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_block_given?'>block_given?</span>
  <span class='id identifier rubyid_acquire_write_lock'>acquire_write_lock</span>
  <span class='kw'>begin</span>
    <span class='kw'>yield</span>
  <span class='kw'>ensure</span>
    <span class='id identifier rubyid_release_write_lock'>release_write_lock</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="write_locked?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>write_locked?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Queries if the write lock is held by any thread.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>true if the write lock is held else false`</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


232
233
234</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/atomic/read_write_lock.rb', line 232</span>

<span class='kw'>def</span> <span class='id identifier rubyid_write_locked?'>write_locked?</span>
  <span class='ivar'>@counter</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span> <span class='op'>&gt;=</span> <span class='const'>RUNNING_WRITER</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Mon Mar  9 09:50:51 2015 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.2.0).
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57940973-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>