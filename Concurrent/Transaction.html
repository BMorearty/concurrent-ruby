<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Concurrent::Transaction
  
    &mdash; Concurrent
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../';
  framesUrl = "../frames.html#!Concurrent/Transaction.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (T)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Concurrent.html" title="Concurrent (module)">Concurrent</a></span></span>
     &raquo; 
    <span class="title">Transaction</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Concurrent::Transaction
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Concurrent::Transaction</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/concurrent/tvar.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Defined Under Namespace</h2>
<p class="children">
  
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="Transaction/ReadLogEntry.html" title="Concurrent::Transaction::ReadLogEntry (class)">ReadLogEntry</a></span>, <span class='object_link'><a href="Transaction/UndoLogEntry.html" title="Concurrent::Transaction::UndoLogEntry (class)">UndoLogEntry</a></span>
    
  
</p>

  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="ABORTED-constant" class="">ABORTED =
          
        </dt>
        <dd><pre class="code"><span class='const'>Object</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span></pre></dd>
      
        <dt id="CURRENT_TRANSACTION-constant" class="">CURRENT_TRANSACTION =
          
        </dt>
        <dd><pre class="code"><span class='const'>ThreadLocalVar</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span></pre></dd>
      
        <dt id="AbortError-constant" class="">AbortError =
          
        </dt>
        <dd><pre class="code"><span class='const'>Class</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='const'>StandardError</span><span class='rparen'>)</span></pre></dd>
      
    </dl>
  







  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#current-class_method" title="current (class method)">+ (Object) <strong>current</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#current%3D-class_method" title="current= (class method)">+ (Object) <strong>current=</strong>(transaction) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#abort-instance_method" title="#abort (instance method)">- (Object) <strong>abort</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#commit-instance_method" title="#commit (instance method)">- (Object) <strong>commit</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (Transaction) <strong>initialize</strong> </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A new instance of Transaction.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#read-instance_method" title="#read (instance method)">- (Object) <strong>read</strong>(tvar) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unlock-instance_method" title="#unlock (instance method)">- (Object) <strong>unlock</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#valid%3F-instance_method" title="#valid? (instance method)">- (Boolean) <strong>valid?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#write-instance_method" title="#write (instance method)">- (Object) <strong>write</strong>(tvar, value) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Concurrent::Transaction (class)">Transaction</a></span></tt>) <strong>initialize</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns a new instance of Transaction</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


159
160
161
162
163</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/tvar.rb', line 159</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>
  <span class='ivar'>@write_set</span> <span class='op'>=</span> <span class='const'>Set</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@read_log</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='ivar'>@undo_log</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="current-class_method">
  
    + (<tt>Object</tt>) <strong>current</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


242
243
244</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/tvar.rb', line 242</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span>
  <span class='const'>CURRENT_TRANSACTION</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="current=-class_method">
  
    + (<tt>Object</tt>) <strong>current=</strong>(transaction) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


246
247
248</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/tvar.rb', line 246</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_current='>current=</span><span class='lparen'>(</span><span class='id identifier rubyid_transaction'>transaction</span><span class='rparen'>)</span>
  <span class='const'>CURRENT_TRANSACTION</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_transaction'>transaction</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="abort-instance_method">
  
    - (<tt>Object</tt>) <strong>abort</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


204
205
206
207
208
209
210</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/tvar.rb', line 204</span>

<span class='kw'>def</span> <span class='id identifier rubyid_abort'>abort</span>
  <span class='ivar'>@undo_log</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_entry'>entry</span><span class='op'>|</span>
    <span class='id identifier rubyid_entry'>entry</span><span class='period'>.</span><span class='id identifier rubyid_tvar'>tvar</span><span class='period'>.</span><span class='id identifier rubyid_unsafe_value'>unsafe_value</span> <span class='op'>=</span> <span class='id identifier rubyid_entry'>entry</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_unlock'>unlock</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="commit-instance_method">
  
    - (<tt>Object</tt>) <strong>commit</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


212
213
214
215
216
217
218
219
220
221
222</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/tvar.rb', line 212</span>

<span class='kw'>def</span> <span class='id identifier rubyid_commit'>commit</span>
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>unless</span> <span class='id identifier rubyid_valid?'>valid?</span>

  <span class='ivar'>@write_set</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tvar'>tvar</span><span class='op'>|</span>
    <span class='id identifier rubyid_tvar'>tvar</span><span class='period'>.</span><span class='id identifier rubyid_unsafe_increment_version'>unsafe_increment_version</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_unlock'>unlock</span>
  
  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="read-instance_method">
  
    - (<tt>Object</tt>) <strong>read</strong>(tvar) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


165
166
167
168
169</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/tvar.rb', line 165</span>

<span class='kw'>def</span> <span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='id identifier rubyid_tvar'>tvar</span><span class='rparen'>)</span>
  <span class='const'>Concurrent</span><span class='op'>::</span><span class='id identifier rubyid_abort_transaction'>abort_transaction</span> <span class='kw'>unless</span> <span class='id identifier rubyid_valid?'>valid?</span>
  <span class='ivar'>@read_log</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='const'>ReadLogEntry</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_tvar'>tvar</span><span class='comma'>,</span> <span class='id identifier rubyid_tvar'>tvar</span><span class='period'>.</span><span class='id identifier rubyid_unsafe_version'>unsafe_version</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_tvar'>tvar</span><span class='period'>.</span><span class='id identifier rubyid_unsafe_value'>unsafe_value</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unlock-instance_method">
  
    - (<tt>Object</tt>) <strong>unlock</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


236
237
238
239
240</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/tvar.rb', line 236</span>

<span class='kw'>def</span> <span class='id identifier rubyid_unlock'>unlock</span>
  <span class='ivar'>@write_set</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tvar'>tvar</span><span class='op'>|</span>
    <span class='id identifier rubyid_tvar'>tvar</span><span class='period'>.</span><span class='id identifier rubyid_unsafe_lock'>unsafe_lock</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="valid?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>valid?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


224
225
226
227
228
229
230
231
232
233
234</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/tvar.rb', line 224</span>

<span class='kw'>def</span> <span class='id identifier rubyid_valid?'>valid?</span>
  <span class='ivar'>@read_log</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_log_entry'>log_entry</span><span class='op'>|</span>
    <span class='kw'>unless</span> <span class='ivar'>@write_set</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_log_entry'>log_entry</span><span class='period'>.</span><span class='id identifier rubyid_tvar'>tvar</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_log_entry'>log_entry</span><span class='period'>.</span><span class='id identifier rubyid_tvar'>tvar</span><span class='period'>.</span><span class='id identifier rubyid_unsafe_version'>unsafe_version</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_log_entry'>log_entry</span><span class='period'>.</span><span class='id identifier rubyid_version'>version</span>
        <span class='kw'>return</span> <span class='kw'>false</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="write-instance_method">
  
    - (<tt>Object</tt>) <strong>write</strong>(tvar, value) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/concurrent/tvar.rb', line 171</span>

<span class='kw'>def</span> <span class='id identifier rubyid_write'>write</span><span class='lparen'>(</span><span class='id identifier rubyid_tvar'>tvar</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
  <span class='comment'># Have we already written to this TVar?
</span>
  <span class='kw'>unless</span> <span class='ivar'>@write_set</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_tvar'>tvar</span>
    <span class='comment'># Try to lock the TVar
</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_tvar'>tvar</span><span class='period'>.</span><span class='id identifier rubyid_unsafe_lock'>unsafe_lock</span><span class='period'>.</span><span class='id identifier rubyid_try_lock'>try_lock</span>
      <span class='comment'># Someone else is writing to this TVar - abort
</span>      <span class='const'>Concurrent</span><span class='op'>::</span><span class='id identifier rubyid_abort_transaction'>abort_transaction</span>
    <span class='kw'>end</span>

    <span class='comment'># We&#39;ve locked it - add it to the write set
</span>
    <span class='ivar'>@write_set</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span><span class='id identifier rubyid_tvar'>tvar</span><span class='rparen'>)</span>

    <span class='comment'># If we previously wrote to it, check the version hasn&#39;t changed
</span>
    <span class='ivar'>@read_log</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_log_entry'>log_entry</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_log_entry'>log_entry</span><span class='period'>.</span><span class='id identifier rubyid_tvar'>tvar</span> <span class='op'>==</span> <span class='id identifier rubyid_tvar'>tvar</span> <span class='kw'>and</span> <span class='id identifier rubyid_tvar'>tvar</span><span class='period'>.</span><span class='id identifier rubyid_unsafe_version'>unsafe_version</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_log_entry'>log_entry</span><span class='period'>.</span><span class='id identifier rubyid_version'>version</span>
        <span class='const'>Concurrent</span><span class='op'>::</span><span class='id identifier rubyid_abort_transaction'>abort_transaction</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Record the current value of the TVar so we can undo it later
</span>
  <span class='ivar'>@undo_log</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='const'>UndoLogEntry</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_tvar'>tvar</span><span class='comma'>,</span> <span class='id identifier rubyid_tvar'>tvar</span><span class='period'>.</span><span class='id identifier rubyid_unsafe_value'>unsafe_value</span><span class='rparen'>)</span><span class='rparen'>)</span>

  <span class='comment'># Write the new value to the TVar
</span>
  <span class='id identifier rubyid_tvar'>tvar</span><span class='period'>.</span><span class='id identifier rubyid_unsafe_value'>unsafe_value</span> <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Sat Jun 14 12:46:56 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.4 (ruby-2.1.0).
</div>

<script>
//  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
//    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
//      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
//  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
//
//  ga('create', 'UA-4005004-8', 'pitr.ch');
//  ga('send', 'pageview');
</script>

  </body>
</html>